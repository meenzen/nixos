#!/usr/bin/env bash

set -eo pipefail

source "$(dirname "$0")/lib.sh"

print "=> Starting VM Build"

print "==> Formatting Code"
alejandra . >/dev/null 2>&1

print "==> Building VM"
git add .
nixos-rebuild build-vm --upgrade --verbose --flake .#vm

print "==> Starting VM"
./result/bin/run-vm-vm

echo "Do you want to delete the disk image? [y/N]"

read -r response

if [ "$response" != "y" ]; then
    exit 0
fi

print "==> Deleting Disk Image"
rm -f vm.qcow2
